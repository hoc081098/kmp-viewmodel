{"config":{"lang":["en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"]},"docs":[{"location":"","title":"kmp-viewmodel \ud83d\udd06","text":"<p>Shared ViewModel in Kotlin Multiplatform - A Kotlin Multiplatform library that provides shared MVVM for UI applications. Components are lifecycle-aware on Android. Supports AndroidX SavedStateHandle for restoring state after process death.</p> <p>The ViewModel class is a business logic or screen level state holder. It exposes state to the UI and encapsulates related business logic. Its principal advantage is that it caches state and persists it through configuration changes (on Android).</p> <p> </p>"},{"location":"#author-petrus-nguyen-thai-hoc","title":"Author: Petrus Nguy\u1ec5n Th\u00e1i H\u1ecdc","text":"<p>Liked some of my work? Buy me a coffee (or more likely a beer)</p> <p></p>"},{"location":"#supported-targets","title":"Supported targets","text":"<ul> <li><code>android</code>.</li> <li><code>jvm</code> (must add <code>kotlinx-coroutines-swing</code>/<code>kotlinx-coroutines-javafx</code> to your dependencies to   make sure <code>Dispatchers.Main</code> available).</li> <li><code>js</code> (<code>IR</code>).</li> <li><code>Darwin</code> targets:</li> <li><code>iosArm64</code>, <code>iosArm32</code>, <code>iosX64</code>, <code>iosSimulatorArm64</code>.</li> <li><code>watchosArm32</code>, <code>watchosArm64</code>, <code>watchosX64</code>, <code>watchosX86</code>, <code>watchosSimulatorArm64</code>.</li> <li><code>tvosX64</code>, <code>tvosSimulatorArm64</code>, <code>tvosArm64</code>.</li> <li><code>macosX64</code>, <code>macosArm64</code>.</li> </ul>"},{"location":"#api","title":"API","text":""},{"location":"#0x-release-docs-httpshoc081098githubiokmp-viewmodeldocs0x","title":"0.x release docs: https://hoc081098.github.io/kmp-viewmodel/docs/0.x","text":""},{"location":"#snapshot-docs-httpshoc081098githubiokmp-viewmodeldocslatest","title":"Snapshot docs: https://hoc081098.github.io/kmp-viewmodel/docs/latest","text":""},{"location":"#getting-started","title":"Getting started","text":""},{"location":"#1-kmp-viewmodel-library","title":"1. <code>kmp-viewmodel</code> library","text":"<p>For more information check out the docs.</p>"},{"location":"#2-kmp-viewmodel-savedstate-library","title":"2. <code>kmp-viewmodel-savedstate</code> library","text":"<p>For more information check out the docs.</p>"},{"location":"#roadmap","title":"Roadmap","text":"<ul> <li>[ ] support <code>SaveStateHandle</code>.</li> <li>[ ] add extensions for <code>Flow</code>/<code>StateFlow</code>, to use the ViewModel easily on <code>ios</code>/<code>macOS</code>/<code>tvOS</code>/<code>watchOS</code> platforms.</li> </ul>"},{"location":"#license","title":"License","text":"<pre><code>MIT License\nCopyright (c) 2023 Petrus Nguy\u1ec5n Th\u00e1i H\u1ecdc\n</code></pre>"},{"location":"multiplatform/","title":"Multiplatform","text":""},{"location":"multiplatform/#supported-targets","title":"Supported targets","text":"<ul> <li><code>android</code>.</li> <li><code>jvm</code> (must add <code>kotlinx-coroutines-swing</code>/<code>kotlinx-coroutines-javafx</code> to your dependencies to   make sure <code>Dispatchers.Main</code> available).</li> <li><code>js</code> (<code>IR</code>).</li> <li><code>Darwin</code> targets:</li> <li><code>iosArm64</code>, <code>iosArm32</code>, <code>iosX64</code>, <code>iosSimulatorArm64</code>.</li> <li><code>watchosArm32</code>, <code>watchosArm64</code>, <code>watchosX64</code>, <code>watchosX86</code>, <code>watchosSimulatorArm64</code>.</li> <li><code>tvosX64</code>, <code>tvosSimulatorArm64</code>, <code>tvosArm64</code>.</li> <li><code>macosX64</code>, <code>macosArm64</code>.</li> </ul>"},{"location":"viewmodel-savedstate/","title":"Get started","text":"<p>This library brings:</p> <ul> <li>Android Parcelable interface.</li> <li>The <code>@Parcelize</code> annotation   from kotlin-parcelize compiler plugin.</li> <li>SavedStateHandle   class.</li> </ul> <p>to Kotlin Multiplatform, so they can be used in common code. This is typically used for state/data preservation over Android configuration changes and system-initiated process death , when writing common code targeting Android.</p>"},{"location":"viewmodel-savedstate/#1-add-dependency","title":"1. Add dependency","text":"<ul> <li>Add <code>mavenCentral()</code> to <code>repositories</code> list in <code>build.gradle.kts</code>/<code>settings.gradle.kts</code>.</li> </ul> <pre><code>// settings.gradle.kts\ndependencyResolutionManagement {\n[...]\nrepositories {\nmavenCentral()\n[...]\n}\n}\n</code></pre> <ul> <li>Add dependency to <code>build.gradle.kts</code> of your shared module (must use <code>api</code> configuration).</li> </ul> <pre><code>// build.gradle.kts\nkotlin {\nsourceSets {\nval commonMain by getting {\ndependencies {\napi(\"io.github.hoc081098:kmp-viewmodel-savedstate:0.2.0\")\n}\n}\n}\n}\n</code></pre> <ul> <li>Expose <code>kmp-viewmodel-savedstate</code> to <code>Darwin</code> native side.</li> </ul> <pre><code>// Cocoapods\nkotlin {\ncocoapods {\n[...]\nframework {\nbaseName = \"shared\"\nexport(\"io.github.hoc081098:kmp-viewmodel-savedstate:0.2.0\") // required to expose the classes to iOS.\n}\n}\n}\n\n// -- OR --\n\n// Kotlin/Native as an Apple framework\nkotlin {\nios {\nbinaries {\nframework {\nbaseName = \"shared\"\nexport(\"io.github.hoc081098:kmp-viewmodel-savedstate:0.2.0\") // required to expose the classes to iOS.\n}\n}\n}\n}\n</code></pre> <ul> <li>Optional: apply <code>kotlin-parcelize</code> if you want to use <code>@Parcelize</code> annotation to   generate <code>Parcelable</code> implementation for Android.</li> </ul> <pre><code>// build.gradle.kts\nplugins {\nid(\"kotlin-parcelize\") // Apply the plugin for Android\n}\n</code></pre> Snapshots of the development version are available in Sonatype's snapshots repository. <p> <pre><code>// settings.gradle.kts\ndependencyResolutionManagement {\nrepositoriesMode.set(RepositoriesMode.PREFER_PROJECT)\nrepositories {\nmaven(url = \"https://s01.oss.sonatype.org/content/repositories/snapshots/\")\n[...]\n}\n}\n\n// build.gradle.kts\ndependencies {\napi(\"io.github.hoc081098:kmp-viewmodel-savedstate:0.2.1-SNAPSHOT\")\n}\n</code></pre> </p>"},{"location":"viewmodel-savedstate/#2-overview","title":"2. Overview","text":"<pre><code>public expect class SavedStateHandle {\npublic constructor(initialState: Map&lt;String, Any?&gt;)\npublic constructor()\n\npublic operator fun contains(key: String): Boolean\npublic operator fun &lt;T&gt; get(key: String): T?\npublic fun &lt;T&gt; getStateFlow(key: String, initialValue: T): StateFlow&lt;T&gt;\npublic fun keys(): Set&lt;String&gt;\n\npublic fun &lt;T&gt; remove(key: String): T?\npublic operator fun &lt;T&gt; set(key: String, value: T?): Unit\n}\n</code></pre> <p>The <code>SavedStateHandle</code> class provides some methods to get and set data. On Android, it is a type alias of <code>androidx.lifecycle.SavedStateHandle</code>. On other platforms, it is simply a wrapper of the normal <code>Map&lt;String, Any?&gt;</code>.</p> <p>Because the limitation of Android platform, the data stored in <code>SavedStateHandle</code> must be one of the following types:</p> Type/Class support Array support double double[] int int[] long long[] String String[] byte byte[] char char[] CharSequence CharSequence[] float float[] Parcelable Parcelable[] Serializable Serializable[] short short[] SparseArray Binder Bundle ArrayList Size (only in API 21+) SizeF (only in API 21+) <p>If the class does not extend one of those in the above list, consider making the class parcelable by adding the <code>@Parcelize</code> annotation. See SavedStateHandle supported types docs for more details.</p>"},{"location":"viewmodel-savedstate/#3-usage-example","title":"3. Usage example","text":"<pre><code>import com.hoc081098.kmp.viewmodel.SavedStateHandle\nimport com.hoc081098.kmp.viewmodel.ViewModel\nimport com.hoc081098.kmp.viewmodel.parcelable.Parcelable\nimport com.hoc081098.kmp.viewmodel.parcelable.Parcelize\n\n@Parcelize\ndata class User(val id: Long, val name: String) : Parcelable\n\nclass UserViewModel(\nprivate val savedStateHandle: SavedStateHandle,\nprivate val getUserUseCase: suspend () -&gt; User,\n) : ViewModel() {\nval user: StateFlow&lt;User?&gt; = savedStateHandle.getStateFlow&lt;User?&gt;(USER_KEY, null)\n\nfun getUser() {\nviewModelScope.launch {\ntry {\nsavedStateHandle[USER_KEY] = getUserUseCase()\n} catch (e: CancellationException) {\nthrow e\n} catch (e: Exception) {\ne.printStackTrace()\n}\n}\n}\n\nprivate companion object {\nprivate const val USER_KEY = \"user_key\"\n}\n}\n</code></pre> <p>For more details, please check kmp viewmodel sample.</p>"},{"location":"viewmodel/","title":"Get started","text":""},{"location":"viewmodel/#1-add-dependency","title":"1. Add dependency","text":"<ul> <li>Add <code>mavenCentral()</code> to <code>repositories</code> list in <code>build.gradle.kts</code>/<code>settings.gradle.kts</code>.</li> </ul> <pre><code>// settings.gradle.kts\ndependencyResolutionManagement {\n[...]\nrepositories {\nmavenCentral()\n[...]\n}\n}\n</code></pre> <ul> <li>Add dependency to <code>build.gradle.kts</code> of your shared module (must use <code>api</code> configuration).</li> </ul> <pre><code>// build.gradle.kts\nkotlin {\nsourceSets {\nval commonMain by getting {\ndependencies {\napi(\"io.github.hoc081098:kmp-viewmodel:0.2.0\")\n}\n}\n}\n}\n</code></pre> <ul> <li>Expose <code>kmp-viewmodel</code> to <code>Darwin</code> native side.</li> </ul> <pre><code>// Cocoapods\nkotlin {\ncocoapods {\n[...]\nframework {\nbaseName = \"shared\"\nexport(\"io.github.hoc081098:kmp-viewmodel:0.2.0\") // required to expose the classes to iOS.\n}\n}\n}\n\n// -- OR --\n\n// Kotlin/Native as an Apple framework\nkotlin {\nios {\nbinaries {\nframework {\nbaseName = \"shared\"\nexport(\"io.github.hoc081098:kmp-viewmodel:0.2.0\") // required to expose the classes to iOS.\n}\n}\n}\n}\n</code></pre> Snapshots of the development version are available in Sonatype's snapshots repository. <p> <pre><code>// settings.gradle.kts\ndependencyResolutionManagement {\nrepositoriesMode.set(RepositoriesMode.PREFER_PROJECT)\nrepositories {\nmaven(url = \"https://s01.oss.sonatype.org/content/repositories/snapshots/\")\n[...]\n}\n}\n\n// build.gradle.kts\ndependencies {\napi(\"io.github.hoc081098:kmp-viewmodel:0.2.1-SNAPSHOT\")\n}\n</code></pre> </p>"},{"location":"viewmodel/#2-overview","title":"2. Overview","text":"<pre><code>public expect abstract class ViewModel {\npublic constructor()\npublic constructor(vararg closeables: Closeable)\n\npublic val viewModelScope: CoroutineScope\npublic fun addCloseable(closeable: Closeable)\n\nprotected open fun onCleared()\n}\n</code></pre> <ul> <li> <p>The ViewModel has a <code>viewModelScope</code> which is a <code>CoroutineScope</code> that is cancelled when the   ViewModel   is cleared. Once the ViewModel is cleared, all coroutines launched in this scope will be   cancelled.</p> </li> <li> <p><code>addCloseable</code> method is used to add <code>Closeable</code> that will be closed directly before <code>onCleared</code>   is called.</p> </li> <li> <p><code>onCleared</code> is called when the ViewModel is cleared, you can override this method to do some clean   up work.   But it is recommended to use the <code>addCloseable</code> method instead of overriding <code>onCleared</code> method.</p> </li> </ul>"},{"location":"viewmodel/#3-create-your-viewmodel-in-commonmain-source-set","title":"3. Create your <code>ViewModel</code> in <code>commonMain</code> source set.","text":"<pre><code>class ProductsViewModel(\nprivate val getProducts: GetProducts,\n) : ViewModel() {\nprivate val _eventChannel = Channel&lt;ProductSingleEvent&gt;(Int.MAX_VALUE)\nprivate val _actionFlow = MutableSharedFlow&lt;ProductsAction&gt;(Int.MAX_VALUE)\n\nval stateFlow: StateFlow&lt;ProductsState&gt;\nval eventFlow: Flow&lt;ProductSingleEvent&gt; = _eventChannel.receiveAsFlow()\n\ninit {\n// Close _eventChannel when ViewModel is cleared.\naddCloseable(_eventChannel::close)\n\nstateFlow = _actionFlow\n.transformToStateFlow()\n.stateIn(\nscope = viewModelScope,\nstarted = SharingStarted.Eagerly,\ninitialValue = ProductsState.INITIAL,\n)\n}\n\n// Do business logic here, to convert `ProductsAction`s to `ProductsState`s.\nprivate fun SharedFlow&lt;ProductsAction&gt;.transformToStateFlow(): Flow&lt;ProductsState&gt; = TODO()\n\nfun dispatch(action: ProductsAction) {\n_actionFlow.tryEmit(action)\n}\n}\n</code></pre>"},{"location":"viewmodel/#4-use-common-viewmodel-in-each-platform","title":"4. Use common <code>ViewModel</code> in each platform.","text":"<ul> <li><code>Android</code>: use the <code>ViewModel</code> as a normal <code>AndroidX Lifecycle ViewModel</code>.</li> <li><code>non-Android</code>:</li> <li>Make sure that you call <code>clear()</code> on your ViewModel when it\u2019s no longer needed,     to properly cancel the <code>CoroutineScope</code> and close resources.</li> <li>For example, you should call <code>clear()</code> in <code>deinit</code> block when using <code>ViewModel</code> in <code>Darwin</code>     targets (<code>ios</code>, <code>macos</code>, <code>tvos</code>, <code>watchos</code>).</li> <li>In addition, you should create a wrapper of the common <code>ViewModel</code> in each platform, to consume the     common <code>ViewModel</code> easily and safely.</li> </ul> <p>For more details, please check kmp viewmodel sample.</p> <pre><code>@MainActor\nclass IosProductsViewModel: ObservableObject {\n  private let commonVm: ProductsViewModel\n\n  @Published private(set) var state: ProductsState\n\n  init(commonVm: ProductsViewModel) {\n    self.commonVm = commonVm\n\n    self.state = self.commonVm.stateFlow.typedValue()\n    self.commonVm.stateFlow.subscribeNonNullFlow(\n      scope: self.commonVm.viewModelScope,\n      onValue: { [weak self] in self?.state = $0 }\n    )\n  }\n\n  func dispatch(action: ProductsAction) { self.commonVm.dispatch(action: action) }\n\n  deinit { self.commonVm.clear() }\n}\n</code></pre>"}]}